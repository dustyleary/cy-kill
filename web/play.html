<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/combo?3.2.0/build/cssreset/reset-min.css">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js" type="text/javascript"></script>
    <script src="goban.js" type="text/javascript"></script>
    <script src="gorules.js" type="text/javascript"></script>
    <link rel='stylesheet' type='text/css' href='goban.css'>
</head>
<body>

    <div id='board-mode'>
        <label>Board Mode<br>
            <label><input type='radio' name='boardMode' id='setupMode' checked='checked'/>Setup</label><br>
            <label><input type='radio' name='boardMode' id='playMode'/>Play</label>
        </label>
        <br>
        <br>
        <input type='button' id='resetBoard' value='Reset Board'/><br>
        <input type='button' id='playOut' value='Play Out'/><br>
    </div>
    <div id='board-controls'>
        <label>Board Size: <select class='boardSize'></select></label><br>
        <label>Komi: <input type='text' id='komi' value='6.5'/></label><br>
        <label>Who's Turn:
            <label><input type='radio' name='whosTurn' id='blacksTurn' checked='checked'/>Black</label>
            <label><input type='radio' name='whosTurn' id='whitesTurn'/>White</label>
        </label>
    </div>

    <div style='clear:both'></div>

    <div id='goban'></div>

    <div class='boardState'>Copy & paste board state:<br><textarea class='boardText'></textarea></div>

<script type="text/javascript">
    var goban = new Goban({el:$('#goban')});

    var s = $('select.boardSize')[0];
    $([5,9,13,19]).each(function(i,v) {
        var o = $('<option>'+v+'x'+v+'</option>')[0];
        o.value = v;
        $(s).append(o);
    });
    $(s).change(function(a,b,c) {
        resetBoard(s.value);
    });

    function resetBoard(size, bt) {
        $('select.boardSize')[0].value = size;
        goban.resetBoard(size, bt);
        updateBoardText();
    }

    function onBoardTextChanged() {
        var ta = $('textarea.boardText')[0];
        var bt = ta.value;
        if(false) {
        } else if(bt.length >= 19*19) {
            resetBoard(19, bt);
        } else if(bt.length >= 13*13) {
            resetBoard(13, bt);
        } else if(bt.length >= 9*9) {
            resetBoard(9, bt);
        } else {
            resetBoard(5, bt);
        } 
    }

    var reset = $('#resetBoard')[0];
    $(reset).bind('click', function() { resetBoard(goban.size); });

    var reset = $('#playOut')[0];
    $(reset).bind('click', function() { playOuts(1); });

    var ta = $('textarea.boardText')[0];
    $(ta).bind('input', onBoardTextChanged);

    function updateBoardText() {
        var bt = $('.boardText', this.el)[0];
        bt.value = goban.boardState.join('');
    }

    function isBlacksTurn() {
        var blacksTurn = $('#blacksTurn')[0];
        return blacksTurn.checked;
    }
    function isPlayMode() {
        var playMode = $('#playMode')[0];
        return playMode.checked;
    }

    function setBlacksTurn(v) {
        var blacksTurn = $('#blacksTurn')[0];
        var whitesTurn = $('#whitesTurn')[0];
        blacksTurn.checked = v;
        whitesTurn.checked = !v;
    }

    $(goban).bind('pointClicked', function(e, info) {
        var x = info.x;
        var y = info.y;
        var ps = goban.getPointState(x,y);
        var newPs = '.';
        if(false) {
        } else if(ps == '.') {
            newPs = isBlacksTurn() ? '#' : 'O';
            if(isPlayMode()) {
                setBlacksTurn(!isBlacksTurn());
            }
        } else if(ps == '#') {
            newPs = 'O';
        } else if(ps == 'O') {
            newPs = 'k';
        }
        goban.setPointState(x,y,newPs);
        goban.updateBoardDisplay();
        updateBoardText();
    });

    function playOut() {
        var bt = isBlacksTurn();
        var b = new Board(goban.size, goban.boardState.join(''));
        var passes = 0;
        while(true) {
            var color = bt ? b.BLACK : b.WHITE;
            var move = b.pickRandomMcgMove(color);
            if(move != null) {
                passes = 0;
                b.makeMove(color, move.charCodeAt(0)-97, move.charCodeAt(1)-97);
            } else {
                passes += 1;
                if(passes == 2) {
                    break;
                }
            }
            bt = !bt;
        }
        return b;
    }

    function playOuts(n) {
        var t1 = new Date();
        var b;
        for(var i=0; i<n; i++) {
            b = playOut();
        }
        var t2 = new Date();
        var s = (t2-t1) / 1000;
        console.log(""+n+' playouts in '+s+'s.  playouts per second: '+ n/s);
        resetBoard(goban.size, b.text);
    }

    resetBoard(9);
</script>

</body>
</html>

